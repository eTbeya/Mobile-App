<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Продажби & Хляб – PWA</title>

  <!-- iOS / PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Продажби">
  <meta name="theme-color" content="#ffffff"/>

  <!-- ✅ Правилни пътища за root -->
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root{ --bg:#f7f7f9; --card:#ffffff; --text:#222; --muted:#6c757d; --accent:#0d6efd; }
    body{ background:var(--bg); color:var(--text); }
    .app-container{ max-width:980px; margin:auto; padding:1rem; }
    .card{ border:1px solid #eee; box-shadow:0 4px 16px rgba(0,0,0,.04); }
    .btn-icon{ width:52px; height:52px; display:flex; align-items:center; justify-content:center; border-radius:14px; }
    .nav-rail{ position:sticky; top:0; display:flex; gap:.5rem; flex-wrap:wrap; z-index:1020; }
    .nav-rail .active{ background:var(--accent); color:#fff; }
    .section{ display:none; }
    .section.active{ display:block; }
    .accordion-button{ background:#fff; }
    .totals{ font-weight:600; }
    .pill{ background:#eef4ff; color:#1849a9; font-weight:600; padding:.25rem .5rem; border-radius:999px; }
    .footer-actions{ position:sticky; bottom:0; background:linear-gradient(to top, #fff, #ffffffcc); padding:1rem; border-top:1px solid #eee; }
    .form-text-muted{ color:var(--muted); font-size:.875rem; }
    .lock-badge{ font-size:.9rem; }
  </style>
</head>

<body>
<div class="app-container">

<header class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h1 class="h4 m-0">Продажби & Хляб</h1>
    <div class="form-text-muted">Леко приложение • локално • за ежедневна работа</div>
  </div>

  <div class="text-end">
    <input type="date" id="datePicker" class="form-control form-control-sm mb-2" />
    <div class="d-flex gap-2 justify-content-end">
      <span id="lockState" class="badge text-bg-light">Ден: отключен</span>
      <button class="btn btn-outline-secondary btn-sm" id="openAdmin"><i class="bi bi-shield-lock"></i> Admin</button>
    </div>
  </div>
</header>

<nav class="nav-rail mb-3" id="navRail">
  <button class="btn btn-outline-secondary btn-icon active" data-target="sales"><i class="bi bi-cash-stack"></i></button>
  <button class="btn btn-outline-secondary btn-icon" data-target="breadWaste"><i class="bi bi-basket3"></i></button>
  <button class="btn btn-outline-secondary btn-icon" data-target="delivery"><i class="bi bi-truck"></i></button>
  <button class="btn btn-outline-secondary btn-icon" data-target="deliveryWaste"><i class="bi bi-x-octagon"></i></button>
  <button class="btn btn-outline-secondary btn-icon" data-target="days"><i class="bi bi-calendar2-week"></i></button>
  <button class="btn btn-outline-secondary btn-icon" data-target="settings"><i class="bi bi-gear"></i></button>
</nav>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* === CONFIG / STORAGE KEYS === */
const CFG_KEY = 'pwa-sales-bread-config-v1';
const DATA_KEY = 'pwa-sales-bread-days-v2';
const LAST_OPEN_KEY = 'pwa-sales-bread-lastopen';
const ADMIN_PIN = '5384';

/* === DEFAULT CONFIG === */
const DEFAULT_CONFIG = {
  showSections: {
    'sales': true,
    'breadWaste': true,
    'delivery': true,
    'deliveryWaste': true,
    'days': true,
    'settings': true,
  },
  reviewShow: { sales:true, breadWaste:true, delivery:true, deliveryWaste:true },
  breadTypes: [
    {name:'Базлама', price:2.00},
    {name:'Мини Базлама', price:3.30},
    {name:'Занат.-бял', price:1.90},
    {name:'Занат.-фибри', price:1.90},
    {name:'Занат.-ръжен', price:1.90},
    {name:'Занат.-многозърнест', price:1.90},
    {name:'Ръчен селски', price:1.80},
    {name:'Лимец и закваска', price:1.90},
  ],
  deliveryItems: [
    {name:'Базлама', price:1.65},
    {name:'Мини Базлама', price:0.55},
  ]
};

/* === HELPERS === */
const fmt = n => (Number(n)||0).toFixed(2);
const el = (s, r=document)=>r.querySelector(s);
const els = (s, r=document)=>Array.from(r.querySelectorAll(s));
const todayISO = ()=> new Date().toISOString().slice(0,10);

/* LOAD CONFIG */
function getCfg(){ try{return JSON.parse(localStorage.getItem(CFG_KEY))||structuredClone(DEFAULT_CONFIG);}catch{return structuredClone(DEFAULT_CONFIG);} }
function saveCfg(){ localStorage.setItem(CFG_KEY, JSON.stringify(CFG)); }
let CFG = getCfg();

/* LOAD DATA */
let days = JSON.parse(localStorage.getItem(DATA_KEY)||'{}');
function blankDay(date){ return { date, locked:false, sales:[], breadWaste:[], delivery:[], deliveryWaste:[] }; }
function current(){ return getDay(el('#datePicker').value); }
function getDay(date){ if(!days[date]) days[date]=blankDay(date); return days[date]; }
function saveAll(){ localStorage.setItem(DATA_KEY, JSON.stringify(days)); refreshDaysTable(); syncLockState(); }

/* DATE PICKER INIT */
const datePicker = el('#datePicker');
const last = localStorage.getItem(LAST_OPEN_KEY);
const today = todayISO();
datePicker.value = (!last || last !== today) ? today : last;
localStorage.setItem(LAST_OPEN_KEY, datePicker.value);

/* NAVIGATION */
els('#navRail .btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    els('#navRail .btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    els('.section').forEach(s=>s.classList.remove('active'));
    el(`#section-${btn.dataset.target}`).classList.add('active');
  });
});

/* SECTION VISIBILITY APPLY */
function applyVisibility(){
  Object.entries(CFG.showSections).forEach(([sec,show])=>{
    const sectionEl = el(`#section-${sec}`);
    const navBtn = els('#navRail .btn').find(b=>b.dataset.target===sec);
    if(sectionEl) sectionEl.style.display = show ? '' : 'none';
    if(navBtn) navBtn.style.display = show ? '' : 'none';
  });
}

/* === LOCK / UNLOCK (Read-Only Mode) === */
function syncLockState(){
  const d = current();
  const locked = d.locked;
  el('#lockState').textContent = locked ? 'Ден: заключен' : 'Ден: отключен';
  el('#lockState').className = 'badge ' + (locked?'text-bg-warning':'text-bg-light');

  // Read-only mode only, UI stays active.
  const sections = ['sales','breadWaste','delivery','deliveryWaste'];
  sections.forEach(sec=>{
    els(`#section-${sec} input, #section-${sec} select, #section-${sec} textarea`)
      .forEach(i=> i.readOnly = locked);
  });
}
// END PART 2A
/* === SALES (Продажба) === */
const salesAcc = el('#salesAcc');
el('#addSaleRow').addEventListener('click',()=> addSaleRow());

function addSaleRow(data={shop:'',gross:0,waste:0,note:''}, push=true){
  const day=current();
  const record = push ? (day.sales.push({...data, net:0}), day.sales[day.sales.length-1]) : data;
  const idx = day.sales.indexOf(record);
  const id = 'sale'+idx;

  const card = document.createElement('div');
  card.className='accordion-item';
  card.innerHTML=`
    <h2 class="accordion-header" id="${id}-h">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${id}-c">
        <span class="me-2 pill">#${idx+1}</span>
        <span class="me-2 shop-name">${record.shop||'Магазин'}</span>
        <span class="ms-auto">Нетно: <strong><span class="net">0.00</span> лв</strong></span>
      </button>
    </h2>
    <div id="${id}-c" class="accordion-collapse collapse" data-bs-parent="#salesAcc">
      <div class="accordion-body">
        <div class="row g-2">
          <div class="col-12 col-md-4"><input class="form-control shop" placeholder="Име на магазин" value="${record.shop}"></div>
          <div class="col-6 col-md-3"><input class="form-control gross" type="number" step="0.01" placeholder="Оборот" value="${record.gross}"></div>
          <div class="col-6 col-md-3"><input class="form-control waste" type="number" step="0.01" placeholder="Брак" value="${record.waste}"></div>
          <div class="col-12 col-md-2 d-grid"><button class="btn btn-outline-danger remove"><i class="bi bi-trash"></i></button></div>
          <div class="col-12"><textarea class="form-control note" rows="2" placeholder="Бележка">${record.note}</textarea></div>
        </div>
      </div>
    </div>`;
  salesAcc.appendChild(card);

  const shopI = el('.shop',card), grossI = el('.gross',card), wasteI = el('.waste',card), noteI = el('.note',card);
  const netSpan = el('.net',card), shopLbl = el('.shop-name',card);

  function recalc(){
    record.shop = shopI.value.trim();
    record.gross = Number(grossI.value)||0;
    record.waste = Number(wasteI.value)||0;
    record.note = noteI.value;
    record.net = Math.max(0, record.gross - record.waste);
    netSpan.textContent = fmt(record.net);
    shopLbl.textContent = record.shop||'Магазин';
    updateSalesTotal();
    saveAll();
  }
  [shopI,grossI,wasteI,noteI].forEach(i=>i.addEventListener('input',recalc));
  el('.remove',card).addEventListener('click',()=>{
    const pos = Array.from(salesAcc.children).indexOf(card);
    day.sales.splice(pos,1);
    card.remove();
    updateSalesTotal();
    saveAll();
  });
  recalc();
}

function updateSalesTotal(){
  const total = current().sales.reduce((s,r)=>s+r.net,0);
  el('#salesTotal').textContent = fmt(total);
}

/* === BREAD WASTE (Брак хляб) === */
const breadAcc = el('#breadAcc');
el('#addBreadRow').addEventListener('click',()=> addBreadShop());

function addBreadShop(data={shop:'',lines:[]}, push=true){
  const day=current();
  const record = push ? (day.breadWaste.push({shop:data.shop||'', lines:[]}), day.breadWaste[day.breadWaste.length-1]) : data;
  const idx = day.breadWaste.indexOf(record);
  const id='bw'+idx;

  const card=document.createElement('div');
  card.className='accordion-item';
  card.innerHTML=`
    <h2 class="accordion-header" id="${id}-h">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${id}-c">
        <span class="me-2 pill">#${idx+1}</span>
        <span class="me-2 shop-name">${record.shop||'Магазин'}</span>
        <span class="ms-auto">Сума: <strong><span class="sum">0.00</span> лв</strong></span>
      </button>
    </h2>
    <div id="${id}-c" class="accordion-collapse collapse" data-bs-parent="#breadAcc">
      <div class="accordion-body">
        <div class="row g-2 mb-2">
          <div class="col-12 col-md-6"><input class="form-control shop" placeholder="Име на магазин" value="${record.shop}"></div>
          <div class="col-12 col-md-6 text-end"><button class="btn btn-outline-primary addLine"><i class="bi bi-plus-lg"></i> Добави артикул</button></div>
        </div>
        <div class="lines"></div>
        <div class="text-end mt-2">Междинна сума: <strong><span class="sum2">0.00</span> лв</strong></div>
        <div class="text-end mt-2"><button class="btn btn-outline-danger remove"><i class="bi bi-trash"></i> Премахни магазин</button></div>
      </div>
    </div>`;
  breadAcc.appendChild(card);

  const shopI = el('.shop',card), shopLbl=el('.shop-name',card), sum=el('.sum',card), sum2=el('.sum2',card), linesWrap=el('.lines',card);

  function recompute(){
    record.shop = shopI.value.trim();
    shopLbl.textContent = record.shop || 'Магазин';
    const total = (record.lines||[]).reduce((s,l)=>s+(Number(l.total)||0),0);
    sum.textContent = fmt(total);
    sum2.textContent = fmt(total);
    updateBreadTotal();
    saveAll();
  }

  el('.addLine',card).addEventListener('click',()=>{
    record.lines.push({type:CFG.breadTypes[0]?.name||'', qty:0, unit:CFG.breadTypes[0]?.price||0, total:0});
    makeBreadLineRow(linesWrap, record.lines, recompute);
    recompute();
  });
  el('.remove',card).addEventListener('click',()=>{
    const pos = Array.from(breadAcc.children).indexOf(card);
    day.breadWaste.splice(pos,1);
    card.remove();
    updateBreadTotal();
    saveAll();
  });
  shopI.addEventListener('input',recompute);

  (data.lines||[]).forEach(l=>{
    record.lines.push({...l});
    makeBreadLineRow(linesWrap, record.lines, recompute);
  });
  recompute();
}

function makeBreadLineRow(container, lines, onChange){
  const row = document.createElement('div');
  row.className='row g-2 align-items-center mb-1';
  row.innerHTML=`
    <div class="col-6 col-md-4"><select class="form-select type"></select></div>
    <div class="col-3 col-md-2"><input type="number" class="form-control qty" min="0" step="1"></div>
    <div class="col-3 col-md-2"><input type="number" class="form-control unit" step="0.01"></div>
    <div class="col-12 col-md-3 text-end"><span>Общо: <strong class="lineTotal">0.00</strong> лв</span></div>
    <div class="col-12 col-md-1 d-grid"><button class="btn btn-outline-danger remove"><i class="bi bi-x"></i></button></div>`;
  container.appendChild(row);

  const typeSel = el('.type',row), qtyI=el('.qty',row), unitI=el('.unit',row), total=el('.lineTotal',row);

  function populate(){
    typeSel.innerHTML='';
    CFG.breadTypes.forEach(b=>{ const o=document.createElement('option'); o.value=b.name; o.textContent=`${b.name} — ${fmt(b.price)} лв`; typeSel.appendChild(o); });
  }
  populate();

  function syncUnit(){
    const m = CFG.breadTypes.find(b=>b.name===typeSel.value);
    if(m) unitI.value = m.price;
  }

  function rec(){
    const idx = Array.from(container.children).indexOf(row);
    const q = Number(qtyI.value)||0;
    const u = Number(unitI.value)||0;
    const t = q*u;
    lines[idx] = {type:typeSel.value, qty:q, unit:u, total:t};
    total.textContent = fmt(t);
    onChange();
  }

  typeSel.addEventListener('change',()=>{syncUnit();rec();});
  qtyI.addEventListener('input',rec);
  unitI.addEventListener('input',rec);
  el('.remove',row).addEventListener('click',()=>{
    const pos = Array.from(container.children).indexOf(row);
    lines.splice(pos,1);
    row.remove();
    onChange();
  });

  syncUnit(); rec();
}

function updateBreadTotal(){
  const total = current().breadWaste.reduce((s,rec)=> s + (rec.lines||[]).reduce((ss,l)=>ss+(l.total||0),0), 0);
  el('#breadTotal').textContent = fmt(total);
}

/* === DELIVERY (Доставка) === */
const deliveryBody = el('#deliveryBody');
el('#addDeliveryRow').addEventListener('click',()=> addDeliveryLine());

function addDeliveryLine(data={item:CFG.deliveryItems[0]?.name||'', qty:0, unit:CFG.deliveryItems[0]?.price||0, total:0}, push=true){
  const day=current();
  if(push) day.delivery.push({...data});
  const idx = day.delivery.indexOf(data);
  const tr = document.createElement('tr');
  tr.innerHTML=`
    <td><select class="form-select item"></select></td>
    <td><input type="number" class="form-control qty" min="0"></td>
    <td><input type="number" class="form-control unit" step="0.01"></td>
    <td class="text-end"><span class="lineTotal">0.00</span> лв</td>
    <td class="text-end"><button class="btn btn-sm btn-outline-danger remove"><i class="bi bi-x"></i></button></td>`;
  deliveryBody.appendChild(tr);

  const itemSel=el('.item',tr), qtyI=el('.qty',tr), unitI=el('.unit',tr), total=el('.lineTotal',tr);

  function populate(){
    itemSel.innerHTML='';
    CFG.deliveryItems.forEach(d=>{ const o=document.createElement('option'); o.value=d.name; o.textContent=`${d.name} — ${fmt(d.price)} лв`; itemSel.appendChild(o); });
  }
  populate();

  function rec(){
    const i = Array.from(deliveryBody.children).indexOf(tr);
    const q = Number(qtyI.value)||0;
    const u = Number(unitI.value)||0;
    const t = q*u;
    day.delivery[i] = {item:itemSel.value, qty:q, unit:u, total:t};
    total.textContent = fmt(t);
    updateDeliveryTotals();
    saveAll();
  }

  itemSel.addEventListener('change',()=>{
    const m=CFG.deliveryItems.find(d=>d.name===itemSel.value);
    if(m) unitI.value=m.price;
    rec();
  });
  qtyI.addEventListener('input',rec);
  unitI.addEventListener('input',rec);
  el('.remove',tr).addEventListener('click',()=>{
    const pos = Array.from(deliveryBody.children).indexOf(tr);
    day.delivery.splice(pos,1);
    tr.remove();
    updateDeliveryTotals();
    saveAll();
  });

  itemSel.value = data.item;
  qtyI.value = data.qty;
  unitI.value = data.unit;
  rec();
}

/* === DELIVERY WASTE (Брак артикули) === */
const dwBody = el('#dwBody');
el('#addDWRow').addEventListener('click',()=> addDWLine());

function addDWLine(data={item:CFG.deliveryItems[0]?.name||'', qty:0, unit:CFG.deliveryItems[0]?.price||0, total:0}, push=true){
  const day=current();
  if(push) day.deliveryWaste.push({...data});
  const tr = document.createElement('tr');
  tr.innerHTML=`
    <td><select class="form-select item"></select></td>
    <td><input type="number" class="form-control qty" min="0"></td>
    <td><input type="number" class="form-control unit" step="0.01"></td>
    <td class="text-end"><span class="lineTotal">0.00</span> лв</td>
    <td class="text-end"><button class="btn btn-sm btn-outline-danger remove"><i class="bi bi-x"></i></button></td>`;
  dwBody.appendChild(tr);

  const itemSel=el('.item',tr), qtyI=el('.qty',tr), unitI=el('.unit',tr), total=el('.lineTotal',tr);

  function populate(){
    itemSel.innerHTML='';
    CFG.deliveryItems.forEach(d=>{ const o=document.createElement('option'); o.value=d.name; o.textContent=`${d.name} — ${fmt(d.price)} лв`; itemSel.appendChild(o); });
  }
  populate();

  function rec(){
    const i = Array.from(dwBody.children).indexOf(tr);
    const q = Number(qtyI.value)||0;
    const u = Number(unitI.value)||0;
    const t = q*u;
    day.deliveryWaste[i] = {item:itemSel.value, qty:q, unit:u, total:t};
    total.textContent = fmt(t);
    updateDeliveryTotals();
    saveAll();
  }

  itemSel.addEventListener('change',()=>{
    const m=CFG.deliveryItems.find(d=>d.name===itemSel.value);
    if(m) unitI.value=m.price;
    rec();
  });
  qtyI.addEventListener('input',rec);
  unitI.addEventListener('input',rec);
  el('.remove',tr).addEventListener('click',()=>{
    const pos = Array.from(dwBody.children).indexOf(tr);
    day.deliveryWaste.splice(pos,1);
    tr.remove();
    updateDeliveryTotals();
    saveAll();
  });

  itemSel.value = data.item;
  qtyI.value = data.qty;
  unitI.value = data.unit;
  rec();
}

function updateDeliveryTotals(){
  const d = current();
  const a = d.delivery.reduce((s,l)=>s+(l.total||0),0);
  const b = d.deliveryWaste.reduce((s,l)=>s+(l.total||0),0);
  el('#deliveryTotal').textContent = fmt(a);
  el('#dwTotal').textContent = fmt(b);
}
// END PART 2B
/* === DAYS (Архив) === */
const daysTable = el('#daysTable');

function refreshDaysTable(){
  daysTable.innerHTML='';
  Object.values(days)
    .sort((a,b)=> b.date.localeCompare(a.date))
    .forEach(d=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${d.date}</td>
        <td>${d.locked?'<span class="badge text-bg-warning">заключен</span>':'<span class="badge text-bg-success">отворен</span>'}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-primary view" data-date="${d.date}"><i class="bi bi-eye"></i></button>
          <button class="btn btn-sm btn-outline-secondary load" data-date="${d.date}"><i class="bi bi-box-arrow-in-down"></i></button>
          <button class="btn btn-sm btn-outline-danger del" data-date="${d.date}"><i class="bi bi-trash"></i></button>
        </td>`;
      daysTable.appendChild(tr);
    });

  els('.view',daysTable).forEach(b=>b.addEventListener('click',()=> openReview(b.dataset.date)));
  els('.load',daysTable).forEach(b=>b.addEventListener('click',()=>{ datePicker.value=b.dataset.date; hydrateAll(); }));
  els('.del',daysTable).forEach(b=>b.addEventListener('click',()=> deleteDay(b.dataset.date)));
}

function deleteDay(date){
  if(!confirm(`Да изтрия деня ${date}? Това не може да бъде отменено.`)) return;
  delete days[date];
  saveAll();
  refreshDaysTable();
}

/* === REVIEW MODAL (Преглед на ден) === */
el('#reviewBtn').addEventListener('click',()=> openReview(datePicker.value));

function openReview(date){
  const d = getDay(date);
  el('#revDate').textContent = date;

  const sTotal = d.sales.reduce((s,r)=>s+(r.net||0),0);
  const bwTotal = d.breadWaste.reduce((s,rec)=> s + (rec.lines||[]).reduce((ss,l)=>ss+(l.total||0),0), 0);
  const delTotal = d.delivery.reduce((s,l)=>s+(l.total||0),0);
  const dwTotal = d.deliveryWaste.reduce((s,l)=>s+(l.total||0),0);

  let html = `
    <div><strong>Нетен оборот:</strong> ${fmt(sTotal)} лв</div>
    <div><strong>Брак хляб (не вади):</strong> ${fmt(bwTotal)} лв</div>
    <div><strong>Доставки:</strong> ${fmt(delTotal)} лв</div>
    <div><strong>Брак артикули:</strong> ${fmt(dwTotal)} лв</div>
    <hr>
  `;

  if(CFG.reviewShow.sales){
    html += `<h6>Продажба:</h6>` + (d.sales.map((r,i)=>`#${i+1} ${r.shop} → Оборот ${fmt(r.gross)} / Брак ${fmt(r.waste)} / Нетно ${fmt(r.net)}`).join('<br>') || '<em>Няма</em>') + '<hr>';
  }
  if(CFG.reviewShow.breadWaste){
    html += `<h6>Брак хляб:</h6>` + (d.breadWaste.map((r,i)=>`#${i+1} ${r.shop}<br>${(r.lines||[]).map(l=>`${l.type}: ${l.qty}×${fmt(l.unit)} = ${fmt(l.total)} лв`).join('<br>')}`).join('<br><br>') || '<em>Няма</em>') + '<hr>';
  }
  if(CFG.reviewShow.delivery){
    html += `<h6>Доставка:</h6>` + ((d.delivery||[]).map(l=>`${l.item}: ${l.qty}×${fmt(l.unit)} = ${fmt(l.total)} лв`).join('<br>') || '<em>Няма</em>') + '<hr>';
  }
  if(CFG.reviewShow.deliveryWaste){
    html += `<h6>Брак артикули:</h6>` + ((d.deliveryWaste||[]).map(l=>`${l.item}: ${l.qty}×${fmt(l.unit)} = ${fmt(l.total)} лв`).join('<br>') || '<em>Няма</em>');
  }

  el('#reviewContent').innerHTML = html;
  new bootstrap.Modal('#reviewModal').show();
}

/* === ADMIN PANEL (PIN) === */
el('#openAdmin').addEventListener('click',()=> adminAccess());
el('#openAdmin2')?.addEventListener('click',()=> adminAccess());

function adminAccess(){
  const pin = prompt('Въведи PIN:');
  if(pin !== ADMIN_PIN) return;
  loadAdminUI();
  new bootstrap.Modal('#adminModal').show();
}

/* === ЗАПАЗВАНЕ / ПРИКЛЮЧВАНЕ / ОТКЛЮЧВАНЕ НА ДЕН === */

el('#saveDay').addEventListener('click',()=>{
  days[current().date]=current();
  saveAll();
  alert('Денят е запазен.');
});

el('#closeDay').addEventListener('click',()=>{
  const d = current();
  d.locked = true;
  saveAll();

  // автоматично следващ ден
  const next = addDaysISO(d.date, 1);
  datePicker.value = next;

  // създаваме празен ден без да копираме стария (важно за да няма дублиране)
  if(!days[next]) days[next] = blankDay(next);
  saveAll();
  hydrateAll();

  alert(`Ден ${d.date} е приключен.\nСтартиран е нов ден: ${next}`);
});

el('#unlockDay').addEventListener('click',()=>{
  current().locked = false;
  saveAll();
  alert('Денят е отключен и може да се редактира.');
});


/* === АНАЛИЗ (СЕДМИЦА / МЕСЕЦ / РЪЧНИ ДАТИ) === */

const fromDate = el('#fromDate');
const toDate   = el('#toDate');

function computeAnalytics(){
  const f = new Date(fromDate.value+'T00:00:00');
  const t = new Date(toDate.value+'T23:59:59');

  let gross=0, waste=0, net=0;

  Object.values(days).forEach(d=>{
    const dd = new Date(d.date+'T12:00:00');
    if(dd>=f && dd<=t){
      d.sales.forEach(r=>{
        gross += Number(r.gross)||0;
        waste += Number(r.waste)||0;
        net   += Number(r.net)||0;
      });
    }
  });

  el('#anGross').textContent = fmt(gross);
  el('#anWaste').textContent = fmt(waste);
  el('#anNet').textContent   = fmt(net);
}

['change','input'].forEach(ev=>{
  fromDate.addEventListener(ev, computeAnalytics);
  toDate.addEventListener(ev, computeAnalytics);
});

/* Седмица по ISO */
function startOfISOWeek(date){
  const d=new Date(date);
  const day=(d.getDay()+6)%7;
  d.setDate(d.getDate()-day);
  return d;
}
function endOfISOWeek(date){
  const s=startOfISOWeek(date);
  const d=new Date(s);
  d.setDate(s.getDate()+6);
  return d;
}

/* Месец */
function startOfMonth(date){ return new Date(date.getFullYear(), date.getMonth(), 1); }
function endOfMonth(date){ return new Date(date.getFullYear(), date.getMonth()+1, 0); }

el('#rWeek').addEventListener('change',()=>{
  if(!el('#rWeek').checked) return;
  const now = new Date(datePicker.value+'T00:00:00');
  fromDate.value = startOfISOWeek(now).toISOString().slice(0,10);
  toDate.value   = endOfISOWeek(now).toISOString().slice(0,10);
  computeAnalytics();
});

el('#rMonth').addEventListener('change',()=>{
  if(!el('#rMonth').checked) return;
  const now = new Date(datePicker.value+'T00:00:00');
  fromDate.value = startOfMonth(now).toISOString().slice(0,10);
  toDate.value   = endOfMonth(now).toISOString().slice(0,10);
  computeAnalytics();
});


/* === HYDRATE (ФИКСИРАН — БЕЗ ДУБЛИРАНЕ) === */

function hydrateAll(){

  const d = current();

  // изчистваме UI напълно (това е ключът към липсата на дублиране)
  el('#salesAcc').innerHTML='';
  el('#breadAcc').innerHTML='';
  el('#deliveryBody').innerHTML='';
  el('#dwBody').innerHTML='';

  // Продажба
  (d.sales||[]).forEach(rec=> addSaleRow(rec, false));
  updateSalesTotal();

  // Брак хляб
  (d.breadWaste||[]).forEach(rec=> addBreadShop(rec, false));
  updateBreadTotal();

  // Доставка
  (d.delivery||[]).forEach(()=> makeLine(el('#deliveryBody'), d.delivery));
  [...el('#deliveryBody').children].forEach((tr,i)=>{
    el('.item',tr).value = d.delivery[i].item;
    el('.qty',tr).value = d.delivery[i].qty;
    el('.unit',tr).value = d.delivery[i].unit;
    el('.qty',tr).dispatchEvent(new Event('input'));
  });

  // Брак от доставка
  (d.deliveryWaste||[]).forEach(()=> makeLine(el('#dwBody'), d.deliveryWaste));
  [...el('#dwBody').children].forEach((tr,i)=>{
    el('.item',tr).value = d.deliveryWaste[i].item;
    el('.qty',tr).value = d.deliveryWaste[i].qty;
    el('.unit',tr).value = d.deliveryWaste[i].unit;
    el('.qty',tr).dispatchEvent(new Event('input'));
  });

  refreshDaysTable();
  updateDeliveryTotals();
  syncLockBadge();
  applyVisibility();
  computeAnalytics();
}

/* === START === */
hydrateAll();

/* === SERVICE WORKER (PWA / OFFLINE) === */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js')
    .catch(err => console.log('SW registration failed:', err));
}

/* === iOS FULLSCREEN PWA HINT === */
window.addEventListener('load', () => {
  // remove 300ms click delay on iOS
  document.body.style.cursor = 'pointer';
});

</script>
</body>
</html>
